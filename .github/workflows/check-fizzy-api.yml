name: Check Fizzy Upstream API Changes

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9am UTC
  workflow_dispatch:  # Manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout history branch
        uses: actions/checkout@v4
        with:
          ref: history
          path: history

      - name: Check for API.md changes since last run
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Read the last known SHA
          LAST_SHA=""
          if [ -f history/fizzy-api-last-sha.txt ]; then
            LAST_SHA=$(cat history/fizzy-api-last-sha.txt)
            echo "Last known SHA: $LAST_SHA"
          else
            echo "No previous SHA found, this is the first run"
          fi

          # Get the current latest commit SHA for docs/API.md
          CURRENT_SHA=$(gh api repos/basecamp/fizzy/commits \
            -q '.[0].sha' \
            -f path=docs/API.md \
            -f per_page=1)
          echo "Current SHA: $CURRENT_SHA"

          if [ "$LAST_SHA" = "$CURRENT_SHA" ]; then
            echo "No changes detected"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected!"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT

            # Fetch commits between last SHA and current
            if [ -n "$LAST_SHA" ]; then
              # Get all commits since the last known SHA
              gh api repos/basecamp/fizzy/commits \
                -q '[.[] | {sha: .sha, message: .commit.message, author: .commit.author.name, url: .html_url}]' \
                -f path=docs/API.md \
                -f per_page=100 > all_commits.json

              # Filter to only commits after our last known SHA
              python3 << EOF > commits.json
          import json

          with open('all_commits.json') as f:
              commits = json.load(f)

          last_sha = "$LAST_SHA"
          new_commits = []
          for commit in commits:
              if commit['sha'] == last_sha:
                  break
              new_commits.append(commit)

          print(json.dumps(new_commits))
          EOF
            else
              # First run - just report the latest commit
              gh api repos/basecamp/fizzy/commits \
                -q '[.[] | {sha: .sha, message: .commit.message, author: .commit.author.name, url: .html_url}]' \
                -f path=docs/API.md \
                -f per_page=1 > commits.json
            fi

            echo "New commits:"
            cat commits.json
          fi

      - name: Create or update issue in fizzy-cli
        if: steps.check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.FIZZY_REPO_TOKEN }}
          script: |
            const fs = require('fs');
            const commits = JSON.parse(fs.readFileSync('commits.json', 'utf8'));
            const now = new Date().toISOString().split('T')[0];

            const owner = 'robzolkos';
            const repo = 'fizzy-cli';
            const title = 'ðŸ”” Upstream API.md has changed';

            const commitList = commits.map(c => {
              const sha = c.sha.slice(0, 7);
              return `- [\`${sha}\`](${c.url}) ${c.message.split('\n')[0]} (${c.author})`;
            }).join('\n');

            const body = [
              'Hey @robzolkos ðŸ‘‹',
              '',
              'The upstream `docs/API.md` file has changed in [basecamp/fizzy](https://github.com/basecamp/fizzy).',
              '',
              '## New commits since last check',
              '',
              commitList,
              '',
              '**View all changes:** [Commit history](https://github.com/basecamp/fizzy/commits/main/docs/API.md)',
              '',
              `**Checked:** ${now}`,
              '',
              '---',
              '*This issue was automatically created/updated by the upstream API monitor workflow.*'
            ].join('\n');

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'upstream-api-change'
            });

            if (issues.data.length > 0) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title: title,
                body: body,
                labels: ['upstream-api-change']
              });
              console.log('Created new issue');
            }

      - name: Update history branch with new SHA
        if: steps.check.outputs.changed == 'true'
        run: |
          cd history
          echo "${{ steps.check.outputs.current_sha }}" > fizzy-api-last-sha.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add fizzy-api-last-sha.txt
          git commit -m "Update fizzy API.md SHA to ${{ steps.check.outputs.current_sha }}"
          git push
