name: Check Fizzy Upstream API Changes

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9am UTC
  workflow_dispatch:  # Manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check for recent API.md changes
        id: check
        run: |
          # Fetch the Atom feed and extract commits from last 24 hours
          curl -s "https://github.com/basecamp/fizzy/commits/main/docs/API.md.atom" > feed.xml

          # Get current time minus 24 hours in ISO format
          CUTOFF=$(date -u -d "24 hours ago" +%Y-%m-%dT%H:%M:%SZ)

          # Parse feed and extract recent commits
          python3 << 'EOF' > commits.json
          import xml.etree.ElementTree as ET
          from datetime import datetime, timedelta, timezone
          import json

          cutoff = datetime.now(timezone.utc) - timedelta(hours=24)

          tree = ET.parse('feed.xml')
          root = tree.getroot()
          ns = {'atom': 'http://www.w3.org/2005/Atom'}

          commits = []
          for entry in root.findall('atom:entry', ns):
              updated = entry.find('atom:updated', ns).text
              updated_dt = datetime.fromisoformat(updated.replace('Z', '+00:00'))

              if updated_dt > cutoff:
                  commits.append({
                      'title': entry.find('atom:title', ns).text,
                      'link': entry.find('atom:link', ns).get('href'),
                      'updated': updated,
                      'author': entry.find('atom:author/atom:name', ns).text
                  })

          print(json.dumps(commits))
          EOF

          COMMIT_COUNT=$(python3 -c "import json; print(len(json.load(open('commits.json'))))")

          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Found $COMMIT_COUNT commits in the last 24 hours"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No recent changes"
          fi

      - name: Create or update issue in fizzy-cli
        if: steps.check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.FIZZY_REPO_TOKEN }}
          script: |
            const fs = require('fs');
            const commits = JSON.parse(fs.readFileSync('commits.json', 'utf8'));
            const now = new Date().toISOString().split('T')[0];

            const owner = 'robzolkos';
            const repo = 'fizzy-cli';
            const title = 'ðŸ”” Upstream API.md has changed';

            const commitList = commits.map(c => {
              const sha = c.link.split('/').pop().slice(0, 7);
              const date = new Date(c.updated);
              const relative = Math.round((Date.now() - date) / (1000 * 60 * 60));
              return `- [\`${sha}\`](${c.link}) ${c.title} (${c.author}, ${relative}h ago)`;
            }).join('\n');

            const body = [
              'Hey @robzolkos ðŸ‘‹',
              '',
              'The upstream `docs/API.md` file has changed in [basecamp/fizzy](https://github.com/basecamp/fizzy).',
              '',
              '## Recent commits (last 24 hours)',
              '',
              commitList,
              '',
              '**View all changes:** [Commit history](https://github.com/basecamp/fizzy/commits/main/docs/API.md)',
              '',
              `**Checked:** ${now}`,
              '',
              '---',
              '*This issue was automatically created/updated by the upstream API monitor workflow.*'
            ].join('\n');

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'upstream-api-change'
            });

            if (issues.data.length > 0) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title: title,
                body: body,
                labels: ['upstream-api-change']
              });
              console.log('Created new issue');
            }
